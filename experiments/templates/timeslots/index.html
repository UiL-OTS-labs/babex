{% extends "base/base.html" %}
{% load i18n %}
{% load transformat %}
{% load datatables %}
{% load get_field_name %}
{% load static %}

{% block header_title %}
    {% transformat 'timeslots:home:header' experiment %} - {{ block.super }}
{% endblock %}

{% block html_head %}
    <script src="{% static 'uil.core/js/bootstrap-datetimepicker.min.js' %}"></script>
    <link href="{% static 'uil.core/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet"/>

    <script>
        // Because of I18N reasons, we do this stuff here.
        var strings = {
            'validation_error': "{% trans 'timeslot:error:cannot_validate_datetime' %}",
            'invalid_date': "{% trans 'timeslot:error:invalid_date' %}",
            'invalid_time': "{% trans 'timeslot:error:invalid_time' %}",
            'invalid_datetime': "{% trans 'timeslot:error:invalid_datetime' %}",
            'confirm_delete': "{% trans 'timeslot:warning:deleting_timeslot' %}",
            'confirm_multi_delete': "{% trans 'timeslot:warning:deleting_timeslots' %}",
            'confirm_silent_remove_participant': "{% trans 'timeslot:warning:confirm_silent_remove_participant' %}",
            'confirm_remove_participant': "{% trans 'timeslot:warning:confirm_remove_participant' %}",
        };
    </script>
    <script src="{% static 'experiments/timeslots/timeslot_table.js' %}"></script>
    <script src="{% static 'experiments/timeslots/new-slot.js' %}"></script>

{% endblock %}

{% block content %}
    <div class="uu-inner-container">
        <div class="col-12">
            <h1>
                {% transformat 'timeslots:home:header' experiment %}
            </h1>
            <p>
                {% trans 'timeslots:home:info_text' %}
            </p>
            <form method="post" action="{% url 'experiments:timeslots_bulk_delete' experiment.pk %}">
                {% csrf_token %}
                <table class="dt_custom" width="100%" data-language="{% datatables_lang %}">
                    <thead>
                    <tr>
                        <th>
                            {% get_verbose_field_name "experiments" "TimeSlot" "id" %}
                        </th>
                        <th>
                            {% trans 'timeslots:day' %}
                        </th>
                        <th>
                            {% trans 'timeslots:date' %}
                        </th>
                        <th>
                            {% trans 'timeslots:time' %}
                        </th>
                        <th>
                            {% trans 'timeslots:place' %}
                        </th>
                        <th>
                            {% trans 'timeslots:participant:name' %}
                        </th>
                        <th>
                            {% trans 'timeslots:participant:email' %}
                        </th>
                        <th>
                            {% trans 'experiments:globals:actions' %}
                        </th>
                        <th>
                            <input type="checkbox" id="master_checkbox">
                        </th>
                    </tr>
                    </thead>

                    <tbody>
                    {% for timeslot in object_list %}
                        {# a timeslot can have multiple places, which we want to display seperately #}
                        {% for place in timeslot.places %}
                            <tr>
                                <td>
                                    {{ timeslot.pk }}
                                </td>
                                <td>
                                    {{ timeslot.datetime|date:'l' }}
                                </td>
                                <td>
                                    {{ timeslot.datetime|date:'Y-m-d' }}
                                </td>
                                <td>
                                    {{ timeslot.datetime|date:'H:i' }}
                                </td>
                                <td>
                                    {{ place.n }}
                                </td>
                                {% if place.participant %}
                                    <td>
                                        {{ place.participant.name }}
                                    </td>
                                    <td>
                                        {{ place.participant.email }}
                                    </td>
                                {% else %}
                                    <td>
                                        -
                                    </td>
                                    <td>
                                        -
                                    </td>
                                {% endif %}
                                <td>
                                    {% if place.n == timeslot.max_places %}
                                        <a href="{% url 'experiments:timeslots_delete' experiment.pk timeslot.pk %}" class="icon-delete">
                                            
                                        </a>
                                    {% endif %}
                                    {% if place.participant %}
                                        <a
                                            href="#"
                                            class="icon-remove-participant"
                                            title="{% trans 'timeslots:remove_participant:title' %}"
                                        >
                                            
                                        </a>
                                        <a
                                            href="#"
                                            class="icon-silent-remove-participant"
                                            title="{% trans 'timeslots:silent_remove_participant:title' %}"
                                        >
                                            
                                        </a>
                                    {% endif %}
                                </td>
                                <td>
                                    <input type="checkbox" class="timeslot_checkbox" name="timeslot_{{ timeslot.pk }}[]" value="{{ place.n }}" data-timeslot="{{ timeslot.pk }}" data-n="{{ place.n }}" data-participant="{{ place.participant.pk }}" data-last="{{ timeslot.max_places }}" id="{{ timeslot.pk }}-{{ place.n }}">
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                    </tbody>
                    <tfoot>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            <button type="submit" class="mt-1" id="delete-all-selected">
                                Delete
                            </button>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </form>
        </div>
        <div class="col-12">
            <h3>
                {% trans 'timeslots:home:new_timeslots:header' %}
            </h3>
            <form method="post" class="oneline-form">
                {% csrf_token %}
                {{ form }}
                <button type="submit" id="save-new-slot">
                    {% trans 'experiments:globals:add_button' %}
                </button>
                <br/>
                <br/>
            </form>
        </div>
    </div>
{% endblock %}